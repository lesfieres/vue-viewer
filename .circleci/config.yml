# Javascript Node CircleCI 2.1 configuration file
#
# Check https://circleci.com/docs/2.1/language-javascript/ for more details
#
version: 2.1
executors:
  vue-viewer-docker:
    docker:
      - image: circleci/node:10-browsers
commands:
  install-orient-express:
    description: 'Installs the orient express server either from cache or git clone'
    steps:
      - run:
          name: 'Fetch last commit hash from orient-express repo'
          command: curl --silent -u $GITHUB_USER:GITHUB_PASSWORD https://api.github.com/repos/lesfieres/orient-express/commits | head -3 | tail -1 | cut -c 13-52 > orient-express-last-commit-hash

      - restore_cache:
          keys:
            - v2-orient-express-{{ checksum "orient-express-last-commit-hash" }}

      - run:
          name: 'Checkout and npm install orient-express if not in cache'
          command: |
            ./.circleci/checkout-orient-express.sh
            ./.circleci/npm-install-orient-express.sh
      - run:
          name: 'Prepare .env'
          command: |
            cd orient-express
            echo -n 'GOODREADS_KEY=' >> .env
            echo $GOODREADS_KEY >> .env
            echo -n 'GOODREADS_SECRET=' >> .env
            echo $GOODREADS_SECRET >> .env
            echo -n 'OMBD_KEY=' >> .env
            echo $OMBD_KEY >> .env
      - save_cache:
          paths:
            - orient-express
          key: v2-orient-express-{{ checksum "orient-express-last-commit-hash" }}

  start-orient-express:
    description: 'Starts orient express server on background'
    steps:
      - run:
          name: 'Start orient-express server'
          background: true
          command: cd orient-express && npm run start
jobs:
  test_unit:
    executor: vue-viewer-docker
    working_directory: ~/repo-unit
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}
      - run:
          name: 'Install dependencies'
          command: npm install
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}
      - run:
          name: 'Build the app'
          command: npm run build
      - run:
          name: 'Run unit tests'
          command: npm run test:unit

  test_e2e:
    executor: vue-viewer-docker
    working_directory: ~/repo-e2e
    steps:
      - checkout
      - install-orient-express
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}
      - run:
          name: 'Install dependencies'
          command: npm install
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}
      - run:
          name: 'Build the app'
          command: npm run build
      - start-orient-express
      - run:
          name: 'Run e2e tests'
          command: npm run test:e2e
workflows:
  version: 2.1
  build_and_test_e2e:
    jobs:
      - test_e2e
  build_and_test_unit:
    jobs:
      - test_unit
